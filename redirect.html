<!DOCTYPE html>
<html>
<head>
  <title>My SMART App</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
</head>
<body>
  <h1>Successfully logged in with Cerner</h1>
  <button id="getTokenBtn">Test FHIR API Connectivity :</button>
  <div id="debug"></div>
  <div id="patient"></div>
  <div id="metadata"></div>
  <div id="observation"></div>
  <div id="encounter"></div>
  <div id="condition"></div>
  <div id="error"></div>
  
  <script>
    document.getElementById("getTokenBtn").addEventListener("click", async () => {
      document.getElementById("metadata").innerHTML = '';
      document.getElementById("patient").innerHTML = '';
      document.getElementById("observation").innerHTML = '';
      document.getElementById("encounter").innerHTML = '';
      document.getElementById("condition").innerHTML = '';
      document.getElementById("error").innerHTML = '';
      try {
        const client = await FHIR.oauth2.ready();
        // Debug information
        const debugInfo = {
          patientId: client.patient.id,
          serverUrl: client.state.serverUrl,
          tokenResponse: client.state.tokenResponse,
          patientContext: client.patient,
          state: client.state
        };
        document.getElementById("debug").innerHTML = `<pre>Debug Info: ${JSON.stringify(debugInfo, null, 2)}</pre>`;

        // Get patient ID from token response
        const patientId = client.state.tokenResponse.patient;
        if (!patientId) {
          throw new Error("No patient ID in token response");
        }

        // 1. Patient Data
        try {
          const patientData = await client.request({
            url: `Patient/${patientId}`,
            headers: { 'Accept': 'application/fhir+json' }
          });
          document.getElementById("patient").innerHTML = `<pre>Patient Data: ${JSON.stringify(patientData, null, 2)}</pre>`;
        } catch (err) {
          document.getElementById("patient").innerHTML = `<pre style='color:red'>Patient Error: ${err.message}</pre>`;
        }

        // 2. Metadata (CapabilityStatement)
        try {
          const metadata = await client.request({
            url: 'metadata',
            headers: { 'Accept': 'application/fhir+json' }
          });
          document.getElementById("metadata").innerHTML = `<pre>Metadata: ${JSON.stringify(metadata, null, 2)}</pre>`;
        } catch (err) {
          document.getElementById("metadata").innerHTML = `<pre style='color:red'>Metadata Error: ${err.message}</pre>`;
        }

        // 3. Observation
        try {
          const observationData = await client.request({
            url: `Observation?patient=${patientId}`,
            headers: { 'Accept': 'application/fhir+json' }
          });
          document.getElementById("observation").innerHTML = `<pre>Observation: ${JSON.stringify(observationData, null, 2)}</pre>`;
        } catch (err) {
          document.getElementById("observation").innerHTML = `<pre style='color:red'>Observation Error: ${err.message}</pre>`;
        }

        // 4. Encounter
        try {
          const encounterData = await client.request({
            url: `Encounter?patient=${patientId}`,
            headers: { 'Accept': 'application/fhir+json' }
          });
          document.getElementById("encounter").innerHTML = `<pre>Encounter: ${JSON.stringify(encounterData, null, 2)}</pre>`;
        } catch (err) {
          document.getElementById("encounter").innerHTML = `<pre style='color:red'>Encounter Error: ${err.message}</pre>`;
        }

        // 5. Condition
        try {
          const conditionData = await client.request({
            url: `Condition?patient=${patientId}`,
            headers: { 'Accept': 'application/fhir+json' }
          });
          document.getElementById("condition").innerHTML = `<pre>Condition: ${JSON.stringify(conditionData, null, 2)}</pre>`;
        } catch (err) {
          document.getElementById("condition").innerHTML = `<pre style='color:red'>Condition Error: ${err.message}</pre>`;
        }
      } catch (err) {
        console.error("OAuth2 failure", err);
        document.getElementById("error").innerHTML = `<pre style="color: red">Error: ${JSON.stringify(err, null, 2)}</pre>`;
      }
    });
  </script>
</body>
</html>
